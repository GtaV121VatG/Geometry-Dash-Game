const keys={};
window.addEventListener("keydown", e => keys[e.code]=true);
window.addEventListener("keyup", e => keys[e.code]=false);
window.addEventListener("mousedown", () => keys["Mouse"]=true);
window.addEventListener("mouseup", () => keys["Mouse"]=false);

function startLevel(lvl){
    level = lvl;
    frame = 0;
    scrollX = 0;
    player.y = floorY;
    player.vy = 0;
    player.grounded = true;
    player.mode = "cube";
    obstacles = [];
    portals = [];
    let distance = 200;
    for(let i=0;i<50;i++){
        if(i%5===0) obstacles.push({x:900+i*distance,y:floorY-40});
        if(i===10&&level>=2) portals.push({x:900+i*distance,type:"ship"});
        if(i===20&&level>=3) portals.push({x:900+i*distance,type:"ufo"});
        if(i===30&&level>=4) portals.push({x:900+i*distance,type:"ball"});
        if(i===40&&level>=5) portals.push({x:900+i*distance,type:"spider"});
    }
    state="play";
    canvas.classList.add("playing");
    requestAnimationFrame(loop);
}

function update(){
    frame++;
    scrollX+=5;

    if(keys["Space"] || keys["ArrowUp"] || keys["Mouse"]){
        if(player.mode==="cube" && player.grounded) player.vy=-14;
        if(player.mode==="ship") player.vy-=0.8;
        if(player.mode==="ufo" && player.grounded) player.vy=-12;
        if(player.mode==="spider" && player.grounded) player.vy=-16;
    }

    player.vy += gravity;
    player.y += player.vy;

    if(player.y >= floorY){
        player.y = floorY;
        player.vy = 0;
        player.grounded = true;
    } else {
        player.grounded = false;
    }

    generateParticles(player.x+20, player.y+40, 2);
    for(let i=particles.length-1;i>=0;i--){
        const p=particles[i];
        p.x-=5;
        p.x+=p.vx;
        p.y+=p.vy;
        p.vy+=0.2;
        p.alpha-=0.03;
        if(p.alpha<=0) particles.splice(i,1);
    }

    obstacles.forEach(o=>{
        o.x-=5;
        if(player.x < o.x+30 && player.x+40 > o.x && player.y+40 > o.y){
            startLevel(level); // reset properly
        }
    });

    portals.forEach(p=>{
        p.x-=5;
        if(Math.abs(player.x - p.x)<40){
            player.mode = p.type;
        }
    });

    let totalWidth = obstacles[obstacles.length-1]? obstacles[obstacles.length-1].x : 1000;
    let percent = Math.min(100, Math.floor((scrollX/totalWidth)*100));
    progressFill.style.width = percent+"%";
}
